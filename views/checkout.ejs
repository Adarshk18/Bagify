<%- include('partials/header') %>

<div class="min-h-screen bg-gray-100 dark:bg-gray-900 flex items-center justify-center px-4">
  <div class="bg-white dark:bg-gray-800 shadow-lg p-8 rounded-lg max-w-2xl w-full">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">ğŸ“ Checkout</h2>

    <form action="/orders/submit" method="POST" id="checkoutForm">
      <input type="hidden" name="paymentMode" value="<%= payOnline ? 'razorpay' : 'cod' %>" />
      <input type="hidden" name="lat" id="lat" />
      <input type="hidden" name="lng" id="lng" />

      <script src="/js/location.js"></script>

      <h3 class="font-semibold text-lg mb-2 text-gray-800 dark:text-gray-200">Delivery Address</h3>

      <% if (user && user.addresses && user.addresses.length > 0) { %>
        <div class="mb-4">
          <label class="block mb-1 font-medium text-gray-700 dark:text-gray-300">Choose Saved Address</label>
          <form action="/users/address/save" method="POST" id="saveAddressForm">
            <select
              name="selectedAddress"
              id="savedAddressSelect"
              class="w-full border px-4 py-2 rounded bg-white dark:bg-gray-700 dark:text-white"
            >
              <option value="">-- Select an Address --</option>
              <% user.addresses.forEach((addr, index) => { %>
                <option value="<%= index %>">
                  <%= addr.fullname %> - <%= addr.city %>, <%= addr.pincode %>
                </option>
              <% }) %>
            </select>
            <button
              type="submit"
              class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            >Save Address</button>
          </form>
        </div>
      <% } %>

      <!-- ğŸ“¦ Manual Address Form -->
      <div id="manualAddressForm">
        <%- include('./address-form') %>
      </div>

      <!-- ğŸŒ Auto-Detect Button -->
      <div class="mt-4 flex items-center justify-between" id="detectLocationSection">
        <button
          type="button"
          onclick="detectLocation()"
          class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded"
        >
          ğŸ“ Auto-Detect Location
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const userAddresses = <%- JSON.stringify(user.addresses || []) %>;

  const savedSelect = document.getElementById("savedAddressSelect");
  const manualFields = document.querySelectorAll("#manualAddressForm input");
  const detectSection = document.getElementById("detectLocationSection");

  // Handle dropdown change
  savedSelect?.addEventListener("change", () => {
    const index = savedSelect.value;

    if (index !== "") {
      const addr = userAddresses[index];
      if (addr) {
        document.querySelector("input[name='fullname']").value = addr.name || "";
        document.querySelector("input[name='phone']").value = addr.phone || "";
        document.querySelector("input[name='street']").value = addr.street || "";
        document.querySelector("input[name='city']").value = addr.city || "";
        document.querySelector("input[name='state']").value = addr.state || "";
        document.querySelector("input[name='pincode']").value = addr.pincode || "";
        document.querySelector("input[name='country']").value = addr.country || "";
      }

      manualFields.forEach(input => input.setAttribute("disabled", true));
      detectSection.style.display = "none";
    } else {
      manualFields.forEach(input => input.removeAttribute("disabled"));
      detectSection.style.display = "flex";
    }
  });

  // Prevent form validation if dropdown used
  document.getElementById("checkoutForm").addEventListener("submit", function (e) {
    if (savedSelect?.value !== "") {
      return; // Skip validation if saved address selected
    }

    const requiredFields = [
      "fullname", "phone", "street", "city", "state", "pincode", "country"
    ];

    for (const field of requiredFields) {
      const input = document.querySelector(`input[name="${field}"]`);
      if (input && !input.disabled && input.value.trim() === "") {
        e.preventDefault();
        alert(`Please fill in your ${field}.`);
        return;
      }
    }
  });
</script>

<%- include('partials/footer') %>
