<%- include('partials/header') %>

<div class="max-w-6xl mx-auto px-4 py-10">
  <h2 class="text-3xl font-bold text-gray-800 mb-8">ğŸ“¦ All Orders</h2>

  <a href="/admin/orders/export" class="bg-green-600 text-white px-4 py-2 rounded text-sm float-right mb-4 hover:bg-green-700">
    â¬‡ï¸ Export Orders
  </a>

  <div id="orders-container">
    <% if (orders.length === 0) { %>
      <div class="bg-blue-50 text-blue-700 px-6 py-4 rounded text-center shadow">
        No orders found.
      </div>
    <% } else { %>
      <% orders.forEach(order => { %>
        <div id="order-<%= order._id %>" class="bg-white shadow-md rounded-lg p-6 mb-6 border border-gray-200 <%= order.status === 'Cancelled' ? 'opacity-60 line-through bg-gray-50' : '' %>">
          
          <!-- ğŸ‘¤ User Info -->
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-lg font-semibold text-gray-800">
                <% if (order.user) { %>
                  ğŸ‘¤ <%= order.user.fullname %> (<%= order.user.email %>)
                <% } else { %>
                  <span class="text-gray-500 italic">Unknown User (possibly deleted)</span>
                <% } %>
              </h3>
              <p class="text-sm text-gray-500">Order ID: <%= order._id %></p>
            </div>
            <span class="order-status px-3 py-1 rounded-full text-sm font-medium
              <% if (order.status === 'Pending') { %> bg-yellow-100 text-yellow-800
              <% } else if (order.status === 'Shipped') { %> bg-blue-100 text-blue-800
              <% } else if (order.status === 'Out for Delivery') { %> bg-indigo-100 text-indigo-800
              <% } else if (order.status === 'Delivered') { %> bg-green-100 text-green-800
              <% } else if (order.status === 'Cancelled') { %> bg-red-100 text-red-800
              <% } else { %> bg-gray-100 text-gray-800 <% } %>">
              <%= order.status %>
            </span>
          </div>

          <!-- ğŸ›ï¸ Products List -->
          <ul class="divide-y divide-gray-200 mb-4">
            <% order.products.forEach(p => { 
              const prod = p.product;
            %>
              <li class="py-2 flex justify-between items-center text-gray-700">
                <% if (prod) { %>
                  <div class="flex items-center gap-3">
                    <img src="<%= prod.image %>" alt="Product" class="w-10 h-10 object-cover rounded" />
                    <span class="font-medium"><%= prod.name %></span>
                  </div>
                <% } else { %>
                  <span class="italic text-red-500">[Product Removed]</span>
                <% } %>
                <span class="text-sm">Qty: <%= p.quantity %></span>
              </li>
            <% }) %>
          </ul>

          <!-- ğŸ  Delivery Address -->
          <% if (order.address) { %>
            <div class="mb-4 text-sm text-gray-700 bg-gray-50 rounded p-4 border">
              <p class="font-semibold mb-1">ğŸ  Delivery Address</p>
              <p><%= order.address.fullname %> (<%= order.address.phone %>)</p>
              <p><%= order.address.street %>, <%= order.address.city %> - <%= order.address.pincode %></p>
              <p><%= order.address.state %>, <%= order.address.country %></p>
              <% if (order.address.landmark) { %>
                <p>ğŸ“ Landmark: <%= order.address.landmark %></p>
              <% } %>
            </div>
          <% } %>

          <!-- ğŸ’° Total & Payment & Status Update -->
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <h4 class="text-lg font-semibold text-gray-900">ğŸ’° Total: â‚¹<%= order.totalAmount %></h4>
              <p class="text-sm text-gray-500">ğŸ’³ Payment: <%= order.paymentMethod || 'N/A' %></p>
            </div>

            <form action="/admin/orders/update/<%= order._id %>" method="POST" class="flex items-center gap-3">
              <select name="status" class="border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <% const statuses = ['Pending', 'Shipped', 'Out for Delivery', 'Delivered', 'Cancelled']; %>
                <% statuses.forEach(stat => { %>
                  <option value="<%= stat %>" <%= order.status === stat ? 'selected' : '' %>>
                    <%= stat %>
                  </option>
                <% }) %>
              </select>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-1.5 rounded">
                Update
              </button>
            </form>
          </div>
        </div>
      <% }) %>
    <% } %>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // âœ… When user places an order â†’ Admin sees it instantly
  socket.on("orderPlaced", (order) => {
    const container = document.getElementById("orders-container");

    const div = document.createElement("div");
    div.id = `order-${order._id}`;
    div.className = "bg-white shadow-md rounded-lg p-6 mb-6 border border-gray-200";
    div.innerHTML = `
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 class="text-lg font-semibold text-gray-800">
            ğŸ‘¤ ${order.user?.fullname || "Unknown User"}
          </h3>
          <p class="text-sm text-gray-500">Order ID: ${order._id}</p>
        </div>
        <span class="order-status px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
          ${order.status}
        </span>
      </div>
      <h4 class="text-lg font-semibold text-gray-900">ğŸ’° Total: â‚¹${order.totalAmount}</h4>
    `;
    container.prepend(div);

    showToast("ğŸ†• New order placed!");
  });

  // âœ… When status is updated â†’ Update badge in real-time
  socket.on("orderStatusUpdated", (data) => {
    const orderDiv = document.getElementById(`order-${data.orderId}`);
    if (orderDiv) {
      const statusSpan = orderDiv.querySelector(".order-status");
      statusSpan.textContent = data.status;

      // Reset all bg classes
      statusSpan.className = "order-status px-3 py-1 rounded-full text-sm font-medium";
      if (data.status === "Pending") statusSpan.classList.add("bg-yellow-100", "text-yellow-800");
      else if (data.status === "Shipped") statusSpan.classList.add("bg-blue-100", "text-blue-800");
      else if (data.status === "Out for Delivery") statusSpan.classList.add("bg-indigo-100", "text-indigo-800");
      else if (data.status === "Delivered") statusSpan.classList.add("bg-green-100", "text-green-800");
      else if (data.status === "Cancelled") statusSpan.classList.add("bg-red-100", "text-red-800");

      showToast(`ğŸ“¢ Order #${data.orderId} â†’ ${data.status}`);
    }
  });

  // âœ… Small toast notification
  function showToast(msg) {
    const toast = document.createElement("div");
    toast.className = "fixed top-5 right-5 bg-gray-900 text-white px-4 py-2 rounded shadow z-50";
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
</script>

<%- include('partials/footer') %>
