<%- include('./partials/header') %>

<div class="min-h-screen bg-gray-50 px-6 py-10">
  <div class="bg-white rounded shadow p-6 max-w-3xl mx-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ‘¤ Your Profile</h2>

    <div class="flex flex-col sm:flex-row items-center gap-6 mb-6">
      <form
        action="/users/profile/upload-photo"
        method="POST"
        enctype="multipart/form-data"
        class="flex items-center gap-4"
      >
        <label class="relative cursor-pointer">
          <img
            src="<%= user.avatar || '/images/default-avatar.png' %>"
            class="w-20 h-20 rounded-full object-cover"
          />
          <input
            type="file"
            name="photo"
            class="hidden"
            onchange="this.form.submit()"
          />
          <div
            class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-1 text-xs"
          >
            Edit
          </div>
        </label>
      </form>

      <script>
        // Save avatar path in localStorage
        localStorage.setItem(
          "bagifyUserAvatar",
          "<%= user.avatar || '/images/default-avatar.png' %>"
        );
      </script>

      <div class="text-center sm:text-left">
        <h3 class="text-xl font-semibold text-gray-800">
          <%= user.fullname %>
        </h3>
        <p class="text-gray-600 mt-1"><%= user.email %></p>
        <p class="text-gray-600 mt-1">
          ğŸ“ <%= user.contact || "Not provided" %>
        </p>
      </div>
    </div>

    <hr class="my-6 border-gray-200" />
    <div>
      <h3 class="text-xl font-semibold text-gray-800 mb-3">ğŸ§¾ Recent Orders</h3>

      <% if (!user.orders || user.orders.length === 0) { %>
      <p class="text-gray-500 mb-4">You havenâ€™t placed any orders yet.</p>
      <a href="/shop" class="text-blue-600 hover:underline">â†’ Start Shopping</a>
      <% } else { %>
      <div class="space-y-4">
        <% user.orders.slice(0, 2).forEach(order => { %>
        <div class="border border-gray-200 rounded p-4 bg-gray-50 shadow-sm">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-700 font-mono"
              >#<%= order._id %></span
            >
            <span
              class="text-xs px-2 py-1 rounded-full font-medium <%= order.status === 'Paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700' %>"
            >
              <%= order.status %>
            </span>
          </div>

          <ul class="text-sm text-gray-700 space-y-1">
            <% if (order.products && order.products.length > 0) { %> <%
            order.products.forEach(item => { %>
            <li>
              ğŸ‘œ <%= item.product?.name || '[Product Removed]' %> Ã— <%=
              item.quantity %> â€” â‚¹ <%= item.product?.price ? (item.product.price
              - (item.product.discount || 0)) : '0' %>
            </li>
            <% }) %> <% } else { %>
            <li>ğŸ‘œ [No Products Found]</li>
            <% } %>
          </ul>

          <div class="mt-2 text-right font-semibold text-green-600">
            Total: â‚¹<%= order.totalAmount %>
          </div>
        </div>
        <% }) %>
      </div>

      <% if (user.orders.length >= 2) { %>
      <div class="text-right mt-2">
        <a href="/orders" class="text-blue-600 hover:underline"
          >â†’ See all orders</a
        >
      </div>
      <% } %> <% } %>
    </div>

    <hr class="my-6 border-gray-200" />

    <!-- ğŸ  Address Management Section -->
    <div>
      <h3 class="text-xl font-semibold text-gray-800 mb-3">
        ğŸ  Saved Addresses
      </h3>

      <% if (user.addresses.length === 0) { %>
      <p class="text-gray-500 mb-4">You havenâ€™t saved any addresses yet.</p>
      <% } %>

      <!-- List of saved addresses -->
      <div class="space-y-4">
        <% user.addresses.forEach((addr, i) => { %>
        <div class="border p-4 rounded bg-gray-50 relative">
          <div class="text-sm text-gray-700 space-y-1">
            <p><strong><%= addr.fullname %></strong></p>
            <p><%= addr.phone %></p>
            <p><%= addr.street %>, <%= addr.city %> - <%= addr.pincode %></p>
            <p><%= addr.state %>, <%= addr.country %></p>
            <p class="text-xs text-gray-500">
              ğŸ—“ï¸ <%= new Date(addr.createdAt).toLocaleDateString() %>
            </p>
          </div>
          <!-- Delete Button -->
          <form
            method="POST"
            action="/users/address/delete/<%= i %>"
            class="absolute top-2 right-2"
          >
            <button
              type="submit"
              class="text-red-500 hover:text-red-700 text-xs"
            >
              Delete
            </button>
          </form>
        </div>
        <% }) %>
      </div>

      <!-- Address Form -->
      <div class="mt-6">
        <h4 class="text-lg font-semibold text-gray-700 mb-2">
          â• Add New Address
        </h4>
        <form
          action="/users/address/add"
          method="POST"
          class="grid gap-4 md:grid-cols-2"
        >
          <input
            type="text"
            name="name"
            placeholder="Full Name"
            required
            class="input"
          />
          <input
            type="text"
            name="phone"
            placeholder="Phone Number"
            required
            class="input"
          />
          <input
            type="text"
            name="street"
            placeholder="Street"
            required
            class="input"
          />
          <input
            type="text"
            name="city"
            id="city"
            placeholder="City"
            required
            class="input"
          />
          <input
            type="text"
            name="state"
            placeholder="State"
            required
            class="input"
          />
          <input
            type="text"
            name="pincode"
            id="pincode"
            placeholder="Pincode"
            required
            class="input"
            onchange="fetchAddressFromPincode(this.value)"
          />
          <input
            type="text"
            name="country"
            placeholder="Country"
            required
            class="input"
          />
          <input
            type="text"
            name="landmark"
            placeholder="Landmark (optional)"
            class="input"
          />
          <input type="hidden" name="lat" id="lat" />
          <input type="hidden" name="lng" id="lng" />
          <div class="col-span-2 flex justify-between mt-2">
            <script src="/js/location.js"></script>

            <button
              type="button"
              onclick="detectLocation()"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm"
            >
              ğŸ“ Auto-Detect Location
            </button>
            <button
              type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm"
            >
              Save Address
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="mt-10 text-center sm:text-left">
      <a href="/users/logout" class="text-red-500 hover:underline text-sm"
        >â† Logout</a
      >
    </div>
  </div>
</div>

<%- include('./partials/footer') %>
